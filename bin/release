#!/usr/bin/env bash

# Paths
ROOT_DIR=$(realpath $(dirname "$BASH_SOURCE")/..)
BUILD_DIR="$ROOT_DIR/build"

main() {
  cmd="$1"
  shift

  if [[ "$cmd" == "build" ]]; then
    build "$@"
  elif [[ "$cmd" == "push" ]]; then
    push "$@"
  elif [[ "$cmd" == "status" ]]; then
    status "$@"
  else
    exit_error "IDK what to do with: $1"
  fi
}

use_dir() {
  if [[ -z "$1" ]]; then
    exit_error "Gimme a build dir" 
  fi

  pushd "$1" || exit_error "No build directory: $1" 
}

build() {
  use_dir "$1"
  cp "$BUILD_DIR"/patched.main.js ./main.js
  cp "$BUILD_DIR"/icon.png ./icon.png
  electron-builder
}

push() {
  use_dir "$1"

  bundle="./dist/win-unpacked"
  if [[ ! -d "$bundle" ]]; then
    exit_error "No bundle directory: $bundle"
  fi
  
  butler_target=$(cat "$BUILD_DIR"/win/BUTLER_TARGET.txt)
  if [[ ! "$butler_target" =~ 'unbound' ]]; then
    exit_error "Invalid butler target: $butler_target"
  fi

  echo "Doing butler."
  butler push "$bundle" "$butler_target"
}

status() {
  butler_target=$(cat "$BUILD_DIR"/win/BUTLER_TARGET.txt)
  if [[ ! "$butler_target" =~ 'unbound' ]]; then
    exit_error "Invalid butler target: $butler_target"
  fi

  butler status "$butler_target"
}

exit_error() {
  echo "Error: $@" 1>&2
  exit 1
}

main "$@"